/** @license Search.js 0.0.1
 *  (c) 2013 Hiroki Osame
 *  Search.js may be freely distributed under the MIT license.
 */
var VisualSearch=function(n,t){n.widget("ui.autocomplete",n.ui.autocomplete,{_renderMenu:function(t,i){var u=this,r="";n.each(i,function(n,i){i.category&&i.category!=r&&(t.append("<li class='ui-autocomplete-category'>"+i.category+"<\/li>"),r=i.category);var f=u._renderItemData(t,i);i.category&&i.category==r&&f.children().addClass("category-child")})}});n.fn.getCursorPosition=function(){var i=0,t=this.get(0),r,u;return document.selection?(t.focus(),r=document.selection.createRange(),u=document.selection.createRange().text.length,r.moveStart("character",-t.value.length),i=r.text.length-u):t&&n(t).is(":visible")&&t.selectionStart!=null&&(i=t.selectionStart),i};t.transpose=function(n){for(var r,u=t.union.apply(t,t.map(n,t.keys)),f={},i=0,e=u.length;i<e;i++)r=u[i],f[r]=t.pluck(n,r);return f};var i=Backbone.View.extend({events:{"mousedown .VS-search-box":"clickBox","click .VS-cancel-search-box":"clearSearch","focus input":"unselect","keydown input":"inputkeydown","dblclick .VS-search-box":"highlightSearch"},initialize:function(){var r=this;this.options=t.extend({el:"",defaultquery:[],placeholder:"Enter your search query here...",strict:!0,search:n.noop,parameters:[],defaultquery:[]},this.options);this.searchQuery=new i.SearchQuery(this.options.defaultquery,{parameters:this.options.parameters,strict:this.options.strict}).on({"add remove change:editing":function(n){n.collection&&r.options.search(JSON.stringify(n.collection.getComplete(),function(n,t){return!n||n==="0"||parseInt(n)||n==="key"||n==="operator"||n==="value"?t:undefined}))},all:function(){r.render()},"change:value":function(n){var t=r.searchQuery.indexOf(n);r.newParam({},t+1)}});this.bindKeys();this.render();n(document).on({click:function(t){n(t.target).closest(".VS-search").length&&t.shiftKey||r.searchQuery.invoke("set",{selected:!1})},keydown:t.bind(this.keydown,r),keyup:t.bind(this.bindKeys,r)});this.$el.on("keypress keyup keydown","input",function(){var u=r.$(".VS-search-inner"),e=u.width()-parseInt(u.css("margin-left")),t=n(this),f=n("<span>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:t.css("fontSize"),fontFamily:t.css("fontFamily"),fontWeight:t.css("fontWeight"),letterSpacing:t.css("letterSpacing"),"text-transform":t.css("text-transform"),whiteSpace:"nowrap"}).text(n(this).val()).insertAfter(this),i=f.width()+20;t.width()<i&&i<e&&t.css("width",i);f.remove()})},render:function(){var u=this,t=n(i.template.search_box(this.options)),r=n(".VS-placeholder",t);return this.parameterViews=[],this.searchQuery.length?(r.hide(),n(".VS-search-inner",t).append(this.searchQuery.map(function(n){var t=new i.ParameterView({model:n}).render().el;return u.parameterViews.push(t),t}))):r.show(),this.$el.html(t),this},clickBox:function(i){var f,r,u;if(n(i.target).is(".VS-search-box, .VS-search-inner, .VS-placeholder")){f=this;for(r in this.parameterViews){if(u=n(this.parameterViews[r]),u.offset().top>i.pageY)break;if(!(u.offset().top+u.height()<i.pageY)&&i.pageX<u.offset().left)return t.delay(function(){f.newParam({},r)})}r=r==this.parameterViews.length-1?this.parameterViews.length:r;t.delay(function(){f.newParam({},r)})}},newParam:function(n,t){var r=new i.Parameter(n);this.searchQuery.add(r,{at:t||null})},unselect:function(){this.searchQuery.invoke("set",{selected:!1})},clearSearch:function(){this.searchQuery.reset()},highlightSearch:function(t){n(t.target).is("input, .search_parameter")&&this.searchQuery.invoke("set",{selected:!0})},inputkeydown:function(t){var i=this,u=function(){var n=i.searchQuery.getEditing()[0],r=n.get("editing"),t,u;r===2?(t=i.searchQuery.indexOf(n),n.set("editing",!1),i.newParam({},t+1)):r===!1?(t=i.searchQuery.indexOf(n),n.destroy(),u=i.searchQuery.at(t),u&&u.set("editing",0)):n.set("editing",r+1)},r=function(){var n=i.searchQuery.getEditing()[0],r=n.get("editing"),t;r===0?(t=i.searchQuery.indexOf(n),n.set("editing",!1),i.newParam({},t)):r===!1?(t=i.searchQuery.indexOf(n),n.destroy(),i.searchQuery.at(t-1)&&i.searchQuery.at(t-1).set("editing",2)):n.set("editing",r-1)},f={37:function(){n(t.target).getCursorPosition()==0&&r()},39:function(){var i=n(t.target);i.getCursorPosition()==i.val().length&&u()},8:function(){var i=n(t.target);if(i.getCursorPosition()===0&&i.get(0).selectionStart===i.get(0).selectionEnd)return r(),!1},9:function(){t.shiftKey?(t.preventDefault(),r()):(t.preventDefault(),u())},13:function(){n(t.target).blur()}};return f[t.keyCode]?f[t.keyCode]():null},keydown:function(t){if(t&&n(".VS-search .selected").length!==0)return[8,37,38,39,40].indexOf(t.keyCode)!=-1?!1:void 0},bindKeys:function(r){if(r&&n(".VS-search .selected").length!==0){var u=this,f={8:function(){var n=u.searchQuery.where({selected:!0});n.forEach(function(n){n.destroy()})},13:function(){var n=u.searchQuery.where({selected:!0});n[0].set("editing",0)},39:function(){var e=u.searchQuery.where({selected:!0}),n=u.searchQuery.indexOf(t.last(e)),r=u.searchQuery.at(n+1),f;u.unselect();r?r.set("selected",!0):(f=new i.Parameter,u.searchQuery.add(f,{at:n+1}))},37:function(){var e=u.searchQuery.where({selected:!0}),n=u.searchQuery.indexOf(t.first(e)),r=u.searchQuery.at(n-1),f;u.unselect();n===-1?u.searchQuery.at(u.searchQuery.length-1).set("selected",!0):r?r.set("selected",!0):(f=new i.Parameter,u.searchQuery.add(f,{at:0}))},38:function(){u.unselect();t.first(u.searchQuery.models).set("selected",!0)},40:function(){u.unselect();t.last(u.searchQuery.models).set("selected",!0)}};return f[r.keyCode]?f[r.keyCode]():null}}});return i.template={search_box:t.template('<div class="VS-search">\n  <div class="VS-search-box-wrapper VS-search-box">\n    <div class="VS-icon VS-icon-search"><\/div>\n    <div class="VS-placeholder"><%= placeholder %><\/div>\n    <div class="VS-search-inner"><\/div>\n    <div class="VS-icon VS-icon-cancel VS-cancel-search-box" title="clear search"><\/div>\n  <\/div>\n<\/div>'),search_parameter:t.template('<div class="search_parameter_remove VS-icon VS-icon-cancel"><\/div><div class="key"><%- model.get(\'key\') %><\/div><div class="operator"><%- model.get(\'operator\') %><\/div><div class="value"><%- model.get(\'value\') %><\/div>')},i.ParameterView=Backbone.View.extend({className:"search_parameter",events:{"focus input":"inputFocused","blur input":"inputBlurred",click:"click","click div.VS-icon-cancel":"delete","keydown input":"keydown"},render:function(){var r=this,t=this.model.collection.parameters;return template=n(i.template.search_parameter({model:this.model})),this.$el.html(template),this.key={dom:n("<input/>").attr({autocomplete:"off",type:"text",name:"key",value:this.model.get("key")}),autocomplete:{minLength:0,delay:0,source:t.category,select:function(t,i){this.value=i.item.value;n(this).blur()}}},this.operator={dom:n("<input/>").attr({autocomplete:"off",name:"operator",placeholder:"==",value:this.model.get("operator"),size:"2"}),autocomplete:{minLength:0,delay:0,source:function(n,i){var f=r.model.get("key"),u=t.key.indexOf(f);t.operators[u]?i(t.operators[u]):i(["==","!=","<",">","≤","≥"])},select:function(t,i){this.value=i.item.value;n(this).blur()}}},this.value={dom:n("<input/>").attr({autocomplete:"off",name:"value",value:this.model.get("value"),placeholder:this.model.get("placeholder"),type:this.model.get("type"),min:this.model.get("min"),max:this.model.get("max"),maxlength:this.model.get("maxlength"),size:this.model.has("value")?this.model.get("value").length:10}),autocomplete:{minLength:0,delay:0,source:function(n,i){var f=r.model.get("key"),u=t.key.indexOf(f);console.log("parameters",t);console.log("parameter values[i]",t.values[u]);console.log("parameter values",t.values);console.log("res",i);console.log("req",n);console.log("i",u);console.log("key",f);t.getValues!=null&&t.getValues[u]!=null?(console.log("search js get value",f),t.getValues[u](f,n.term,i)):i(t.values[u])},select:function(t,i){this.value=i.item.value;n(this).blur()}}},this.model.has("key")&&this.model.get("editing")!==0?this.model.has("operator")&&this.model.get("editing")!==1?this.model.has("value")&&this.model.get("editing")!==2?this.model.get("selected")&&this.$el.addClass("selected"):this.autocomplete(this.$("div.value").html(this.value.dom).children(),this.value.autocomplete).focus(0):this.autocomplete(this.$("div.operator").html(this.operator.dom).children(),this.operator.autocomplete).focus(0):this.autocomplete(this.$("div.key").html(this.key.dom).children(),this.key.autocomplete).focus(0),this},inputFocused:function(t){n(t.target).autocomplete("search","")},inputBlurred:function(t){var i=n(t.target),r=this.model.get("editing"),u;(u={editing:r<2?r+1:null})[i.attr("name")]=i.val();this.model.set(u)},click:function(n){var i,r;n.target.localName!="input"&&(i=this.model.clicked,clearTimeout(i.timeout),i.timeout=setTimeout(function(){i.count=0},300),i.count>0?this.dblclick(n):(r=this,t.delay(function(){r.model.set("selected",!0)})),i.count++)},dblclick:function(t){var i=n(t.target);i.is("div.key")?this.model.set("editing",0):i.is("div.operator")?this.model.set("editing",1):i.is("div.value")&&this.model.set("editing",2)},"delete":function(){this.model.destroy()},autocomplete:function(n,t){return n.autocomplete(t).autocomplete("widget").addClass("VS-interface"),n},keydown:function(){}}),i.Parameter=Backbone.Model.extend({defaults:{key:null,value:null,placeholder:"",type:"text",operator:null,maxlength:null,max:null,min:null,selected:!1,editing:!1,getValues:function(){return[]}},initialize:function(){this.setType();this.on({"change:key change:operator change:value":function(n,t){if(!t)return n.destroy();n.hasChanged("key")&&n.setType()}})},incomplete:function(){return!(this.has("key")&&this.has("operator")&&this.has("value"))},clicked:{count:0,timeout:null},setType:function(){var i=this.get("key"),n,t;if(i){if(n=this.collection,t=n.parameters.key.indexOf(i),n.strict&&t===-1)return this.destroy();t!==-1&&this.set({type:n.parameters.type[t],placeholder:n.parameters.placeholder[t],min:n.parameters.min[t],max:n.parameters.max[t]})}}}),i.SearchQuery=Backbone.Collection.extend({model:i.Parameter,initialize:function(n,i){t.extend(this,i);this.parameters=t.transpose(this.parameters);for(var r in this.parameters.key)this.parameters.category[r]={label:this.parameters.key[r],category:this.parameters.category[r]}},getEditing:function(){return t.filter(this.models,function(t){return n.isNumeric(t.get("editing"))||t.incomplete()})},getComplete:function(){return t.filter(this.models,function(n){return!n.incomplete()})}}),i}(jQuery,_);